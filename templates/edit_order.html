<!-- templates/edit_order.html -->
{% extends "admin_base.html" %}

{% block title %}Edit Order - {{ order.order_id }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-edit"></i> Edit Order {{ order.order_id }}</h1>
        <a href="{{ url_for('order_details', order_id=order.order_id) }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Order
        </a>
    </div>

    {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-user-edit"></i> Edit Order Details</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="customer_name" class="form-label">Customer Name *</label>
                                <input type="text" class="form-control" id="customer_name" 
                                       name="customer_name" value="{{ order.customer_name }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="contact_number" class="form-label">Contact Number *</label>
                                <input type="tel" class="form-control" id="contact_number" 
                                       name="contact_number" value="{{ order.contact_number }}" required
                                       pattern="[0-9]{10,11}" title="10-11 digit phone number">
                                <div class="form-text">Format: 10-11 digits (e.g., 0123456789)</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="address" class="form-label">Address *</label>
                            <textarea class="form-control" id="address" name="address" rows="3" required>{{ order.address }}</textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="postcode" class="form-label">Postcode *</label>
                                <input type="text" class="form-control" id="postcode" 
                                       name="postcode" value="{{ order.postcode }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="state" class="form-label">State *</label>
                                <select class="form-select" id="state" name="state" required>
                                    <option value="">Select State</option>
                                    {% for state in states %}
                                    <option value="{{ state }}" {% if order.state == state %}selected{% endif %}>
                                        {{ state }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="status" class="form-label">Order Status</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="reserved" {% if order.status == 'reserved' %}selected{% endif %}>Reserved</option>
                                    <option value="confirmed" {% if order.status == 'confirmed' %}selected{% endif %}>Confirmed</option>
                                    <option value="processing" {% if order.status == 'processing' %}selected{% endif %}>Processing</option>
                                    <option value="shipped" {% if order.status == 'shipped' %}selected{% endif %}>Shipped</option>
                                    <option value="completed" {% if order.status == 'completed' %}selected{% endif %}>Completed</option>
                                    <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="payment_status" class="form-label">Payment Status</label>
                                <select class="form-select" id="payment_status" name="payment_status">
                                    <option value="pending" {% if order.payment_status == 'pending' %}selected{% endif %}>Pending</option>
                                    <option value="pending_verification" {% if order.payment_status == 'pending_verification' %}selected{% endif %}>Pending Verification</option>
                                    <option value="verified" {% if order.payment_status == 'verified' %}selected{% endif %}>Verified</option>
                                    <option value="rejected" {% if order.payment_status == 'rejected' %}selected{% endif %}>Rejected</option>
                                    <option value="cancelled" {% if order.payment_status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="tracking_number" class="form-label">Tracking Number</label>
                            <input type="text" class="form-control" id="tracking_number" 
                                   name="tracking_number" value="{{ order.tracking_number or '' }}"
                                   placeholder="Enter tracking number if shipped">
                        </div>

                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> Important Notes</h6>
                            <ul class="mb-0">
                                <li>Changing the state may update shipping fee and total price</li>
                                <li>All changes are logged and notified via Telegram</li>
                                <li>Required fields are marked with *</li>
                            </ul>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                            <a href="{{ url_for('order_details', order_id=order.order_id) }}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Order Summary -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-receipt"></i> Order Summary</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th class="text-center">Qty</th>
                                    <th class="text-end">Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in items %}
                                <tr>
                                    <td>{{ item.product_name }}</td>
                                    <td class="text-center">{{ item.quantity }}</td>
                                    <td class="text-end">RM{{ "%.2f"|format(item.price) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="2" class="text-end"><strong>Subtotal:</strong></td>
                                    <td class="text-end">RM{{ "%.2f"|format(order.total_price - order.shipping_fee) }}</td>
                                </tr>
                                <tr>
                                    <td colspan="2" class="text-end"><strong>Shipping:</strong></td>
                                    <td class="text-end">RM{{ "%.2f"|format(order.shipping_fee) }}</td>
                                </tr>
                                <tr>
                                    <td colspan="2" class="text-end"><strong>Total:</strong></td>
                                    <td class="text-end"><strong>RM{{ "%.2f"|format(order.total_price) }}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('send_payment_link', order_id=order.order_id) }}" 
                           class="btn btn-warning" target="_blank">
                            <i class="fas fa-link"></i> Send Payment Link
                        </a>
                        
                        {% if order.payment_status == 'pending_verification' %}
                        <a href="{{ url_for('admin_verify_payments') }}" 
                           class="btn btn-success">
                            <i class="fas fa-check-circle"></i> Verify Payment
                        </a>
                        {% endif %}
                        
                        {% if order.status != 'shipped' and order.payment_status == 'verified' %}
                        <button type="button" class="btn btn-info" 
                                onclick="addTracking('{{ order.order_id }}')">
                            <i class="fas fa-truck"></i> Add Tracking
                        </button>
                        {% endif %}
                        
                        {% if order.status != 'completed' %}
                        <a href="{{ url_for('complete_order', order_id=order.order_id) }}" 
                           class="btn btn-success"
                           onclick="return confirm('Mark order {{ order.order_id }} as completed?')">
                            <i class="fas fa-check-double"></i> Mark as Completed
                        </a>
                        {% endif %}
                        
                        {% if order.status != 'cancelled' %}
                        <a href="{{ url_for('cancel_order', order_id=order.order_id) }}" 
                           class="btn btn-danger"
                           onclick="return confirm('Cancel order {{ order.order_id }}? This cannot be undone.')">
                            <i class="fas fa-times"></i> Cancel Order
                        </a>
                        {% endif %}
                        
                        <a href="{{ url_for('delete_order', order_id=order.order_id) }}" 
                           class="btn btn-outline-danger"
                           onclick="return confirm('⚠️ DELETE ORDER {{ order.order_id }}?\\n\\nThis will permanently delete: \\n• Order details\\n• Order items\\n• Payment information\\n\\nThis action cannot be undone!')">
                            <i class="fas fa-trash"></i> Delete Order
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function addTracking(orderId) {
    const trackingNumber = prompt('Enter tracking number for order ' + orderId + ':');
    if (trackingNumber && trackingNumber.trim() !== '') {
        // Submit form to add tracking
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/orders/add_tracking/${orderId}`;
        
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'tracking_number';
        input.value = trackingNumber.trim();
        
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
}
</script>

<style>
.card {
    border-radius: 10px;
    overflow: hidden;
}

.btn {
    border-radius: 5px;
}

.table-sm th, .table-sm td {
    padding: 0.5rem;
}

.alert {
    border-radius: 8px;
    border: none;
}

.form-control, .form-select {
    border-radius: 5px;
}

.d-grid.gap-2 .btn {
    margin-bottom: 0.5rem;
}
</style>
{% endblock %}